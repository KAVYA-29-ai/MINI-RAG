"""
PDF Text Extraction - In-memory processing
Production-ready for Render deployment
"""
import io
import logging
from pypdf import PdfReader

logger = logging.getLogger(__name__)

# Constants
MAX_FILE_SIZE_MB = 20
MAX_PAGES = 500

def extract_text_from_pdf(file_bytes: bytes) -> str:
    """
    Extract text from PDF bytes (no disk I/O).
    
    Args:
        file_bytes: PDF file content as bytes
        
    Returns:
        Extracted text as string
        
    Raises:
        ValueError: If PDF is invalid, empty, or exceeds limits
    """
    # Input validation
    if not file_bytes:
        raise ValueError("Empty PDF file provided")
    
    # Check file size
    file_size_mb = len(file_bytes) / (1024 * 1024)
    if file_size_mb > MAX_FILE_SIZE_MB:
        raise ValueError(f"PDF size ({file_size_mb:.1f}MB) exceeds {MAX_FILE_SIZE_MB}MB limit")
    
    logger.info(f"üìÑ Processing PDF ({file_size_mb:.2f}MB)")
    
    try:
        # Create in-memory stream
        pdf_stream = io.BytesIO(file_bytes)
        reader = PdfReader(pdf_stream)
        
        # Validate pages
        total_pages = len(reader.pages)
        if total_pages == 0:
            raise ValueError("PDF has no pages")
        
        # Limit pages
        pages_to_process = min(total_pages, MAX_PAGES)
        if total_pages > MAX_PAGES:
            logger.warning(f"‚ö†Ô∏è PDF has {total_pages} pages, limiting to {MAX_PAGES}")
        
        # Extract text
        full_text = []
        empty_pages = 0
        
        for i in range(pages_to_process):
            try:
                page = reader.pages[i]
                text = page.extract_text()
                
                if text and text.strip():
                    full_text.append(text)
                else:
                    logger.warning(f"‚ö†Ô∏è Page {i+1} has no text (may be scanned)")
                    empty_pages += 1
                    
            except Exception as e:
                logger.error(f"‚ùå Page {i+1} extraction failed: {e}")
                empty_pages += 1
        
        # Validate extraction
        if not full_text:
            raise ValueError(
                f"No text extracted from {total_pages} pages. "
                "PDF may be scanned/image-based. Text PDFs required."
            )
        
        # Combine text
        combined_text = "\n\n".join(full_text)
        
        logger.info(f"‚úÖ Extracted {len(full_text)}/{pages_to_process} pages ({empty_pages} failed)")
        
        return combined_text
        
    except ValueError:
        raise
    except Exception as e:
        logger.error(f"‚ùå PDF extraction failed: {e}")
        raise ValueError(f"Failed to process PDF: {str(e)}")